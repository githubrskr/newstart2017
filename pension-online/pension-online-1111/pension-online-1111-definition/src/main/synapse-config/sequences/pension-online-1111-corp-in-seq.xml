<?xml version="1.0" encoding="UTF-8"?>
<sequence xmlns="http://ws.apache.org/ns/synapse" name="pension-online-1111-corp-in-seq">
    
    <!-- print log for receiving the successful request payload data from MDTP -->
    <call-template target="DESLogTemplate">
        <with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_IN_RECEIVED"></with-param>
        <with-param name="message" value="Starting service."></with-param>
        <with-param name="category" value="INFO"></with-param>
    </call-template>
    
    <!-- Logging prefix for the generic fault sequence -->
    <property name="PODS_CURRENT_PRX" value="PODS_GET_SCHEMES_FOR_PENSION_SCHEME_ADMINISTRATOR" scope="default" type="STRING" />
    <property name="correlationId" expression="$trp:CorrelationId"/>    
    <property name="acknowledgementReference" expression="translate($trp:correlationID,'-','')"/>
	
  <property name="dateformat" value="yyyy-MM-dd'T'HH:mm:ss'Z'"/>
     
	<xslt key="gov:/PensionsOnlineDigitalService/PensionSchemeAdminRequestIn.xslt">
		<property name="transmittingSystem" expression="get-property('system','uk.gov.hmrc.wso2.etmp.esb.pods.TRANSMITTING_SYSTEM')"/>
		<property name="originatingSystem" expression="get-property('system','uk.gov.hmrc.wso2.etmp.esb.pods.ORIGINATING_SYSTEM')"/>
    	<property name="receiptDate" expression="get-property('SYSTEM_DATE', get-property('dateformat'))"/>
		<property name="acknowledgementRefValue" expression="$ctx:acknowledgementReference"/>
 	</xslt>
    
    <!-- Validate the outgoing request payload against the XSD -->
   <validate xmlns:subm="http://hmrc.gov.uk/etmp/digitalgateway/PODS" xmlns:ns="http://org.apache.synapse/xsd" source="//subm:ETMP_Transaction">
		<schema key="gov:/PensionsOnlineDigitalService/schemas/ETMP_PODSPSASubscriptionCreate_Request.xsd" />
		<resource location="ETMP_PODSPSASubscriptionCreate_ReqHeader.xsd" key="gov:/PensionsOnlineDigitalService/schemas/ETMP_PODSPSASubscriptionCreate_ReqHeader.xsd" />
        <resource location="ETMP_PODSPSASubscriptionCreate_Body.xsd" key="gov:/PensionsOnlineDigitalService/schemas/ETMP_PODSPSASubscriptionCreate_Body.xsd" />
		<on-fail>
			<call-template target="DESLogTemplate">
				<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_REQUEST_VALIDATION" />
				<with-param name="message" value="Request validation failed, unexpected request generated. Sending back 500." />
				<with-param name="httpStatus" value="500" />
				<with-param name="category" value="ERROR" />
			</call-template>
			<call-template target="FailureResponseTemplate">
				<with-param name="DES_HTTP_SC" value="500" />
				<with-param name="DES_CODE" value="SERVER_ERROR" />
				<with-param name="DES_REASON" value="DES is currently experiencing problems that require live service intervention." />
				<with-param name="DES_CONTENT_TYPE" value="application/json" />
			</call-template>
		</on-fail>
	</validate>
    <!-- END - Validate the payload against the XSD -->
    
    <call-template target="DESLogTemplate">
        <with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_IN_REQUEST"></with-param>
        <with-param name="message" value="Sending request to backend."></with-param>
        <with-param name="category" value="INFO"></with-param>
    </call-template>
	
     <!-- Authorise and send to ETMP -->
    <sequence key="PensionsOnlineDigitalServiceAuth" description="ETMP Authentication"/>
  	<send>
		<endpoint name="ETMP_PODS_SOAP_PENSIONS_SCHEME_ADMIN" template="gov:/PensionsOnlineDigitalService/templates/PODS_SOAP_EP_TPL.xml" uri="http://{system.prop.uk.gov.hmrc.wso2.pods.backend.ETMP_HOST_PORT}/{system.prop.uk.gov.hmrc.wso2.pods.backend.ETMP_PODS_PENSION_SCHEME_ADMIN_SUBSCRIPTION_CTX}"></endpoint>	
	</send>

</sequence>