<?xml version="1.0" encoding="UTF-8"?>
<sequence xmlns="http://ws.apache.org/ns/synapse" name="pension-online-1111-data-in-seq">

    <call-template target="DESLogTemplate">
        <with-param name="label" value="DATA_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RECEIVED"/>
        <with-param name="message" value="Starting pension-online-1111-data-in-seq."/>
        <with-param name="category" value="INFO"/>
    </call-template>

	<!-- Logging prefix for the generic fault sequence -->
    <property name="PODS_CURRENT_PRX" value="DATA_PENSION_SCHEME_ADMIN_SUBSCRIPTION" scope="default" type="STRING" />
    
    <property name="INITIAL_JSON_INPUT" expression="json-eval($.)" scope="default" type="STRING"/>
    <JSONValidatorMediator>
        <json expression="$ctx:INITIAL_JSON_INPUT"/>
        <schema expression="get-property('gov:/PensionsOnlineDigitalService/schemas/PensionSchemeAdminSubscriptionRequestSchema.json')"/>
        <base64 value="true"/>
    </JSONValidatorMediator>

    <switch xmlns:ns="http://org.apache.synapse/xsd" source="$ctx:isJsonValid">
        <case regex="true">
            <sequence key="PODSAuthorizationForESBCorp"/>
            <call-template target="DESLogTemplate">
                <with-param name="label" value="DATA_PENSION_SCHEME_ADMIN_SUBSCRIPTION_REQUEST"/>
                <with-param name="message" value="Sending request to Corporate tier."/>
                <with-param name="category" value="INFO"/>
            </call-template>
            <send>
                <endpoint name="PODS_HTTP_POST_EP_TPL" template="gov:/PensionsOnlineDigitalService/templates/PODS_HTTP_POST_EP_TPL.xml" uri="http://{system.prop.uk.gov.hmrc.wso2.corp.esb.FAST_ESB_HOST_PORT}/pension-online/subscription" />
            </send>
        </case>
        <default>
            <call-template target="DESLogTemplate">
                <with-param name="label" value="DATA_PENSION_SCHEME_ADMIN_SUBSCRIPTION_VALIDATION"/>
                <with-param name="message" value="Invalid Submission. Sending 400 response back."/>
                <with-param name="httpStatus" value="400"/>
                <with-param name="category" value="INFO"/>
            </call-template>
            <call-template target="FailureResponseTemplate">
                <with-param name="DES_HTTP_SC" value="400"/>
                <with-param name="DES_CODE" value="INVALID_PAYLOAD"/>
                <with-param name="DES_REASON" value="Submission has not passed validation. Invalid PAYLOAD."/>
                <with-param name="DES_CONTENT_TYPE" value="application/json"/>
            </call-template>
            <drop/>
        </default>
    </switch>
</sequence>