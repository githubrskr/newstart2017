<?xml version="1.0" encoding="UTF-8"?>
<sequence xmlns="http://ws.apache.org/ns/synapse" name="pension-online-1111-corp-out-seq">

	<call-template target="DESLogTemplate">
        <with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE_RECEIVED"/>
        <with-param name="message" value="Starting API PODS Pension Scheme Administrator Subscription Out Sequence."/>
        <with-param name="category" value="INFO"/>
    </call-template>
    
    <!-- Logging prefix for the generic fault sequence -->
    <property name="PODS_CURRENT_PRX" value="PODS_GET_SCHEMES_FOR_PENSION_SCHEME_ADMINISTRATOR" scope="default" type="STRING" />
	
	<switch xmlns:ns="http://org.apache.synapse/xsd" source="$axis2:HTTP_SC">
		<case regex="200">
			<validate>
				<schema key="gov:/PensionsOnlineDigitalService/schemas/ETMP_PODSPSASubscriptionCreate_Response.xsd" />
				<on-fail>
					<call-template target="DESLogTemplate">
						<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE_VALIDATION" />
						<with-param name="message" value="Invalid backend response. Sending 503 response back." />
						<with-param name="httpStatus" value="503" />
						<with-param name="category" value="ERROR" />
					</call-template>
					<call-template target="FailureResponseTemplate">
						<with-param name="DES_HTTP_SC" value="503" />
						<with-param name="DES_CODE" value="SERVICE_UNAVAILABLE" />
						<with-param name="DES_REASON" value="Dependent systems are currently not responding." />
						<with-param name="DES_CONTENT_TYPE" value="application/json" />
					</call-template>
					<drop/>
				</on-fail>
			</validate>
			<call-template target="DESLogTemplate">
				<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE_VALIDATION"/>
				<with-param name="message" value="Successfully validated backend response against schema."/>
				<with-param name="category" value="INFO"/>
			</call-template>
			<property xmlns:resp="http://hmrc.gov.uk/etmp/digitalgateway/PODS" name="PODS_RESP_STATUS" expression="//resp:ETMP_TransactionResponse/resp:ETMP_Transaction_Header/resp:Status/text()" scope="default" type="STRING" />
			<switch source="$ctx:PODS_RESP_STATUS">
				<case regex="^OK$">
					<property name="HTTP_SC" value="200" scope="axis2" type="STRING" />
					<call-template target="DESLogTemplate">
						<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE" />
						<with-param name="message" value="Successfully processed on the backend. Sending 200 response back." />
						<with-param name="httpStatus" value="200" />
						<with-param name="category" value="INFO" />
					</call-template>
					
					<property name="messageType" value="application/json" scope="axis2"/>
					<xslt key="gov:/PensionsOnlineDigitalService/PensionSchemeAdminRequestOut.xslt" >
                    	<resource location="UtilityTemplates.xslt" key="gov:/PensionsOnlineDigitalService/UtilityTemplates.xslt"/>
					</xslt>	 

					<property name="PAYLOAD_AFTER_XSLT" expression="$body/*[1]" />
					<payloadFactory media-type="json">
						<format>$1</format>
						<args>
							<arg expression="$ctx:PAYLOAD_AFTER_XSLT" />
						</args>
					</payloadFactory>
					<property name="messageType" value="application/json" scope="axis2" /> 
					<send/>
				</case>
				<case regex="^NOT_OK$">
					<property name="messageType" value="application/json" scope="axis2" />
					<property xmlns:resp="http://hmrc.gov.uk/etmp/digitalgateway/PODS" name="RESP_STATUS_CODE"
						expression="//resp:ETMP_TransactionResponse/resp:ETMP_Transaction_Header/resp:ReturnParameters[resp:ParamName = 'ERRORCODE']/resp:ParamValue/text()" scope="default" type="STRING" />
					<property name="LOG_MESSAGE" expression="fn:concat('Error received from the backend, Error code:', $ctx:RESP_STATUS_CODE, '.')" scope="default" type="STRING" description="log message" />
					
					<switch source="$ctx:RESP_STATUS_CODE">
						<case regex="003|999">
							<call-template target="DESLogTemplate">
								<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE" />
								<with-param name="message" value="{fn:concat($ctx:LOG_MESSAGE, 'Sending 503 response back.')}" />
								<with-param name="httpStatus" value="503" />
								<with-param name="category" value="ERROR" />
							</call-template>
							<call-template target="FailureResponseTemplate">
								<with-param name="DES_HTTP_SC" value="503" />
								<with-param name="DES_CODE" value="SERVICE_UNAVAILABLE" />
								<with-param name="DES_REASON" value="Dependent systems are currently not responding." />
								<with-param name="DES_CONTENT_TYPE" value="application/json" />
							</call-template>
							<drop/>
						</case>
						<case regex="004">
							<call-template target="DESLogTemplate">
								<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE" />
								<with-param name="message" value="{fn:concat($ctx:LOG_MESSAGE, 'Sending 409 response back.')}" />
								<with-param name="httpStatus" value="409" />
								<with-param name="category" value="ERROR" />
							</call-template>
							<call-template target="FailureResponseTemplate">
								<with-param name="DES_HTTP_SC" value="409" />
								<with-param name="DES_CODE" value="DUPLICATE_SUBMISSION" />
								<with-param name="DES_REASON" value="Duplicate submission acknowledgement reference from remote endpoint returned." />
								<with-param name="DES_CONTENT_TYPE" value="application/json" />
							</call-template>
							<drop/>
						</case>
						<case regex="007">
							<call-template target="DESLogTemplate">
								<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE" />
								<with-param name="message" value="{fn:concat($ctx:LOG_MESSAGE, 'Sending 403 response back.')}" />
								<with-param name="httpStatus" value="403" />
								<with-param name="category" value="ERROR" />
							</call-template>
							<call-template target="FailureResponseTemplate">
								<with-param name="DES_HTTP_SC" value="403" />
								<with-param name="DES_CODE" value="INVALID_BUSINESS_PARTNER" />
								<with-param name="DES_REASON" value="Business partner already has active subscription for this regime." />
								<with-param name="DES_CONTENT_TYPE" value="application/json" />
							</call-template>
							<drop/>
						</case>
						<default>
							<call-template target="DESLogTemplate">
								<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE" />
								<with-param name="message" value="Unknown error code received from the backend. Sending 503 response back." />
								<with-param name="httpStatus" value="503" />
								<with-param name="category" value="ERROR" />
							</call-template>
							<call-template target="FailureResponseTemplate">
								<with-param name="DES_HTTP_SC" value="503" />
								<with-param name="DES_CODE" value="SERVICE_UNAVAILABLE" />
								<with-param name="DES_REASON" value="Dependent systems are currently not responding." />
								<with-param name="DES_CONTENT_TYPE" value="application/json" />
							</call-template>
							<drop/>
						</default>  
		  	      </switch>
				</case>
				<default>
					<call-template target="DESLogTemplate">
						<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE" />
						<with-param name="message" value="Unknown status received from the backend. Sending 503 response back." />
						<with-param name="httpStatus" value="503" />
						<with-param name="category" value="ERROR" />
					</call-template>
					<call-template target="FailureResponseTemplate">
						<with-param name="DES_HTTP_SC" value="503" />
						<with-param name="DES_CODE" value="SERVICE_UNAVAILABLE" />
						<with-param name="DES_REASON" value="Dependent systems are currently not responding." />
						<with-param name="DES_CONTENT_TYPE" value="application/json" />
					</call-template>
					<drop/>
				</default>
			</switch>
		</case>
      	<!-- handle 500 status code -->
		<case regex="500">
			<!-- Internal Server error -->
			<call-template target="DESLogTemplate">
				<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE" />
				<with-param name="message" value="Service unavailable on the backend. Sending 503 response back." />
				<with-param name="httpStatus" value="500" />
				<with-param name="category" value="ERROR" />
			</call-template>

			<!-- This is a work around to handle soap fault as the wso2 can't handle it -->
			<payloadFactory media-type="xml">
				<format>
					<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
						<soapenv:Body></soapenv:Body>
					</soapenv:Envelope>
				</format>
			</payloadFactory>
			<call-template target="FailureResponseTemplate">
				<with-param name="DES_HTTP_SC" value="503"></with-param>
				<with-param name="DES_CODE" value="SERVICE_UNAVAILABLE"></with-param>
				<with-param name="DES_REASON" value="Dependent systems are currently not responding."></with-param>
				<with-param name="DES_CONTENT_TYPE" value="application/json"></with-param>
			</call-template>
            <drop/>
		</case>
   		<default>
			<call-template target="DESLogTemplate">
				<with-param name="label" value="CORP_PENSION_SCHEME_ADMIN_SUBSCRIPTION_RESPONSE" />
				<with-param name="message" value="Unexpected HTTP status received from the backend. Sending 503 response back." />
				<with-param name="httpStatus" value="503" />
				<with-param name="category" value="ERROR" />
			</call-template>
			<call-template target="FailureResponseTemplate">
				<with-param name="DES_HTTP_SC" value="503" />
				<with-param name="DES_CODE" value="SERVICE_UNAVAILABLE" />
				<with-param name="DES_REASON" value="Dependent systems are currently not responding." />
				<with-param name="DES_CONTENT_TYPE" value="application/json" />
			</call-template>
			<drop/>
		</default>
	</switch>
</sequence>